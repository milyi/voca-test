<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜ë‹¨ì–´ ì•”ê¸° ë„ìš°ë¯¸1</title>

  <!-- ğŸ”¥ defer í•„ìˆ˜ -->
  <script defer src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body { font-family: Arial, sans-serif; max-width: 420px; margin: auto; padding: 20px; }
    h2 { text-align: center; }
    input { width: 100%; padding: 10px; font-size: 16px; margin-top: 8px; }
    button { width: 100%; padding: 12px; margin-top: 12px; font-size: 16px; }
    .question { font-weight: bold; margin-bottom: 10px; }
  </style>
</head>
<body>

<h2>ğŸ“˜ ì˜ë‹¨ì–´ ì•”ê¸° ë„ìš°ë¯¸</h2>

<div id="upload">
  <input type="file" accept="image/*" id="imageInput">

  <!-- ğŸ”¥ type="button" í•„ìˆ˜ -->
  <button type="button" onclick="startQuiz()">â–¶ ë¬¸ì œ ì‹œì‘</button>

  <p style="font-size:14px;">
    ì˜ˆì‹œ: apple a round fruit with red skin ì‚¬ê³¼
  </p>
</div>

<div id="quiz" style="display:none;">
  <div class="question" id="definition"></div>
  <input type="text" id="wordInput" placeholder="ì˜ë‹¨ì–´ ì…ë ¥">
  <input type="text" id="meaningInput" placeholder="ëœ» ì…ë ¥">
  <button type="button" onclick="next()">ë‹¤ìŒ ë¬¸ì œ</button>
</div>

<div id="result" style="display:none;"></div>

<script>
let words = [];
let index = 0;
let results = [];

function startQuiz() {
  console.log("â–¶ ë¬¸ì œ ì‹œì‘ í´ë¦­ë¨");

  if (typeof Tesseract === "undefined") {
    alert("OCR ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }

  const file = document.getElementById('imageInput').files[0];
  if (!file) {
    alert("ì‚¬ì§„ íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  alert("OCRì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œ ê¸°ë‹¤ë¦¬ì„¸ìš”.");

  Tesseract.recognize(file, 'eng+kor')
    .then(result => {
      console.log("OCR ì™„ë£Œ", result.data.text);

      words = result.data.text.split('\n')
        .map(line => line.trim())
        .filter(line => line.split(' ').length >= 3)
        .map(line => {
          const parts = line.split(' ');
          return {
            word: parts[0],
            definition: parts.slice(1, parts.length - 1).join(' '),
            meaning: parts[parts.length - 1]
          };
        });

      if (words.length === 0) {
        alert("ì¸ì‹ëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      shuffle(words);
      document.getElementById('upload').style.display = 'none';
      document.getElementById('quiz').style.display = 'block';
      showQuestion();
    })
    .catch(err => {
      console.error(err);
      alert("OCR ì˜¤ë¥˜ ë°œìƒ");
    });
}

function showQuestion() {
  document.getElementById('definition').innerText =
    "ì˜ì˜í’€ì´: " + words[index].definition;
  document.getElementById('wordInput').value = '';
  document.getElementById('meaningInput').value = '';
}

function next() {
  const wordAnswer = document.getElementById('wordInput').value.trim();
  const meaningAnswer = document.getElementById('meaningInput').value.trim();

  results.push({
    ...words[index],
    wordAnswer,
    meaningAnswer,
    correct:
      wordAnswer.toLowerCase() === words[index].word.toLowerCase() &&
      meaningAnswer === words[index].meaning
  });

  index++;
  if (index < words.length) showQuestion();
  else showResult();
}

function showResult() {
  document.getElementById('quiz').style.display = 'none';

  let score = results.filter(r => r.correct).length;
  let html = `<h3>ê²°ê³¼</h3><p>${score} / ${results.length}</p><ul>`;

  results.forEach(r => {
    html += `<li>${r.definition}<br>
      ì…ë ¥: ${r.wordAnswer || '-'} / ${r.meaningAnswer || '-'}<br>
      ì •ë‹µ: ${r.word} / ${r.meaning}</li><br>`;
  });

  html += `</ul><button type="button" onclick="location.reload()">ğŸ”„ ë‹¤ì‹œ ì‹œí—˜</button>`;
  document.getElementById('result').innerHTML = html;
  document.getElementById('result').style.display = 'block';
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}
</script>

</body>
</html>
